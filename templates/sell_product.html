{% extends "base.html" %}

{% block title %}Sale{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Sale</h1>
    <form method="post" id="sale-form">
        <div class="form-group">
            <label for="barcode">Barcode:</label>
            <input type="text" id="barcode-input" name="barcode" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" class="form-control" min="1" required>
        </div>
        <div class="form-group">
            <label for="discount">Discount (%):</label>
            <input type="number" id="discount" name="discount" class="form-control" min="0" max="100" step="0.01">
        </div>
        <button type="button" id="add-to-receipt" class="btn btn-primary">Add to Receipt</button>
        <button type="button" id="complete-sale" class="btn btn-success">Complete Sale</button>
    </form>

    <h2 class="mt-4">Receipt</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="receipt-items">
            <!-- Items will be dynamically added here -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" class="text-right">Total:</td>
                <td id="total-price">$0.00</td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('barcode-input').addEventListener('change', fetchProductDetails);
    document.getElementById('add-to-receipt').addEventListener('click', addToReceipt);
    document.getElementById('complete-sale').addEventListener('click', completeSale);
});

async function fetchProductDetails() {
    const barcode = document.getElementById('barcode-input').value;
    if (!barcode) return;

    try {
        const response = await fetch(`/api/product?barcode=${barcode}`);
        const product = await response.json();
        if (product && product.name) {
            document.getElementById('product-details').style.display = 'block';
            document.getElementById('product-name').innerText = `Name: ${product.name}`;
            document.getElementById('product-price').innerText = `Price: $${product.sale_price}`;
        } else {
            document.getElementById('product-details').style.display = 'none';
        }
    } catch (error) {
        console.error('Error fetching product details:', error);
    }
}

function addToReceipt() {
    const barcode = document.getElementById('barcode-input').value;
    const quantity = parseInt(document.getElementById('quantity').value, 10);
    const discount = parseFloat(document.getElementById('discount').value) || 0;

    if (!barcode || quantity <= 0) {
        alert('Please provide valid barcode and quantity.');
        return;
    }

    fetch(`/api/product?barcode=${barcode}`)
        .then(response => response.json())
        .then(product => {
            if (product && product.name) {
                const totalPrice = product.sale_price * quantity;
                const discountedPrice = totalPrice - (totalPrice * (discount / 100));

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${quantity}</td>
                    <td>$${product.sale_price.toFixed(2)}</td>
                    <td>$${discountedPrice.toFixed(2)}</td>
                `;
                document.getElementById('receipt-items').appendChild(row);

                updateTotalPrice();
            } else {
                alert('Product not found.');
            }
        })
        .catch(error => console.error('Error adding product to receipt:', error));
}

function updateTotalPrice() {
    let total = 0;
    document.querySelectorAll('#receipt-items tr').forEach(row => {
        const totalCell = row.cells[3];
        total += parseFloat(totalCell.innerText.replace('$', ''));
    });
    document.getElementById('total-price').innerText = `$${total.toFixed(2)}`;
}

async function completeSale() {
    const items = Array.from(document.querySelectorAll('#receipt-items tr')).map(row => {
        return {
            productName: row.cells[0].innerText,
            quantity: parseInt(row.cells[1].innerText, 10),
            price: parseFloat(row.cells[2].innerText.replace('$', '')),
            total: parseFloat(row.cells[3].innerText.replace('$', ''))
        };
    });

    const totalPrice = parseFloat(document.getElementById('total-price').innerText.replace('$', ''));

    try {
        const response = await fetch('/sell_product/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ items, totalPrice })
        });
        const result = await response.json();
        if (result.success) {
            alert('Sale completed successfully!');
            // Optionally, reset form and receipt
        } else {
            alert('Error completing sale.');
        }
    } catch (error) {
        console.error('Error completing sale:', error);
    }
}
</script>
{% endblock %}
